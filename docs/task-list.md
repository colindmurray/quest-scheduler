# Quest Scheduler â€” Task List

## Test Plan Execution Checkpoint
- Last Completed: P3.1 Discord routing + rate limits
- Next Step: Complete
- Open Issues: None
- Last Updated (YYYY-MM-DD): 2026-01-31

## Progress Notes
- 2026-01-31: Archived prior task list to docs/task-list-archive-unified-notification-overhaul-2026-01-31.md.
- 2026-01-31: Ran Claude + Gemini reviews for the plan and task list; incorporated feedback into docs/unified-notification-overhaul.md and docs/decisions.md.
- 2026-01-31: Created docs/plan-execution/unified-notification-overhaul-task-list.md and the execute-plan-unified-notification-overhaul skill.
- 2026-01-31: Tests not run (docs-only changes).
- 2026-01-31: Completed P0.1 (notification constants + alias resolver + rules skeleton). Tests: `npm --prefix functions run test` (pass, 1 skipped).
- 2026-01-31: Completed P0.2 (Firestore rules + rules tests; adjusted pendingNotifications path). Tests: `npm --prefix web run test:rules` (pass).
- 2026-01-31: Completed P0.3 (emitNotificationEvent callable + web wrapper + tests). Tests: `npm --prefix functions run test` (pass, 1 skipped), `npm --prefix web run test` (pass).
- 2026-01-31: Completed P0.4 (notification type normalization + UI compatibility). Tests: `npm --prefix web run test` (pass).
- 2026-01-31: Completed P1.1 (template module + poll invite templates). Tests: `npm --prefix functions run test` (pass, 1 skipped).
- 2026-01-31: Completed P1.2 (router trigger + in-app/email delivery for poll invites + tests). Tests: `npm --prefix functions run test` (pass, 1 skipped).
- 2026-01-31: Completed P1.3 (auto-clear rules + dedupe support + tests). Tests: `npm --prefix functions run test` (pass, 1 skipped).
- 2026-01-31: Completed P1.4 (pending notification reconciliation + callable + web hook). Tests: `npm --prefix functions run test` (pass, 1 skipped), `npm --prefix web run test` (pass).
- 2026-01-31: Completed P2.1 (poll invite flow now emits events; router handles email/in-app). Tests: `npm --prefix functions run test` (pass, 1 skipped), `npm --prefix web run test` (pass), `npm --prefix web run test:e2e:emulators` (pass).
- 2026-01-31: Completed P2.2 (vote/finalize/reopen/slot change emit events + new templates). Tests: `npm --prefix functions run test` (pass, 1 skipped), `npm --prefix web run test` (pass), `npm --prefix web run test:e2e:emulators` (pass).
- 2026-01-31: Completed P2.3 (friend/group invites emit events; removed legacy sync + emails). Tests: `npm --prefix functions run test` (pass, 1 skipped), `npm --prefix web run test` (pass).
- 2026-01-31: Completed P2.4 (notification settings UI + preference-aware router). Tests: `npm --prefix functions run test` (pass, 1 skipped), `npm --prefix web run test` (pass).
- 2026-01-31: Completed P2.5 (notificationEvents TTL + expiresAt + client-side email opt-out removal). Tests: `npm --prefix functions run test` (pass, 1 skipped), `npm --prefix web run test` (pass).
- 2026-01-31: Added staging Firebase config overrides + build script + runbook updates. Tests: `npm --prefix web run test` (pass).
- 2026-01-31: Added `web/.env.staging` with staging Firebase config. Tests not run (env-only change).
- 2026-01-31: Ignored staging OAuth client secret file in `.gitignore`. Tests not run (config change only).
- 2026-01-31: Set `QS_GOOGLE_OAUTH_CLIENT_JSON` Secret Manager value for staging (version 1). Tests not run (infra change only).
- 2026-01-31: Deploy attempt failed; missing secret `DISCORD_APPLICATION_ID` for staging. Need value before retry.
- 2026-01-31: Set staging Discord secrets `DISCORD_PUBLIC_KEY`, `DISCORD_CLIENT_ID`, `DISCORD_CLIENT_SECRET`, `DISCORD_APPLICATION_ID` (v1). Missing `DISCORD_BOT_TOKEN` to deploy.
- 2026-01-31: Set staging `DISCORD_BOT_TOKEN` (v1). Deploy succeeded for hosting/rules/extensions, but some 2nd-gen functions failed due to Eventarc service agent propagation; retry needed.
- 2026-01-31: Updated Discord OAuth tests to read env client values when present. Tests: `npm --prefix functions run test` (pass; 1 skipped: worker integration requires emulator).
- 2026-01-31: Ran functions tests with Firestore emulator. Tests: `FIRESTORE_EMULATOR_HOST=127.0.0.1:8080 npm --prefix functions run test` (pass).
- 2026-01-31: Deployed staging (hosting/functions/firestore/storage/extensions). Follow-up: set Functions artifacts cleanup policy in us-central1.
- 2026-01-31: Re-deployed hosting to finalize live release. Hosting URL live at https://quest-scheduler-stg.web.app (and firebaseapp.com alias).
- 2026-01-31: Set staging Google OAuth client ID in `web/.env.staging` and re-deployed hosting. Tests not run (env-only change + deploy).
- 2026-01-31: Allowed Discord (custom provider) to pass email verification check in Firestore rules. Tests: `npm --prefix web run test:rules` (pass).
- 2026-01-31: Deployed updated Firestore rules to staging project.
- 2026-01-31: Granted `roles/iam.serviceAccountTokenCreator` to quest-scheduler-stg@appspot.gserviceaccount.com for Discord custom token signing.
- 2026-01-31: Completed P3.2 (removed legacy notification writes in web/functions; emit events for group member removed/left and poll invite revokes; added in-app templates + preference gating). Tests: `npm --prefix functions run test` (pass, 1 skipped), `npm --prefix web run test` (pass).
- 2026-01-31: Completed P3.1 (router Discord delivery, discord message builder + tests; removed direct Discord sends in scheduler triggers). Tests: `npm --prefix functions run test` (pass, 1 skipped), `npm --prefix web run test` (pass).
- 2026-01-31: Re-ran function tests after Timestamp expiry fix in legacy functions. Tests: `npm --prefix functions run test` (pass, 1 skipped).
- 2026-01-31: Ran E2E emulator suite. Tests: `npm --prefix web run test:e2e:emulators` (pass).
- 2026-01-31: Quieted emulator/deprecation noise in `scripts/run-e2e.sh` and re-ran E2E suite. Tests: `npm --prefix web run test:e2e:emulators` (pass).
- 2026-01-31: Added composite Firestore indexes for notification queries and deployed to staging. Tests not run (index-only change).
- 2026-01-31: Fixed `userVoteRef` undefined in scheduler voting flow by returning it from `useSchedulerData`. Tests: `npm --prefix web run test` (pass).
- 2026-01-31: Deployed staging hosting with the `userVoteRef` fix. Tests: `npm --prefix web run test` (pass).
- 2026-01-31: Ran coverage. Tests: `npm --prefix web run test:coverage` (pass), `npm --prefix functions run test -- --coverage` (pass, 1 skipped).
- 2026-01-31: Enabled Discord worker integration test by auto-starting Firestore emulator when needed. Tests: `npm --prefix functions run test -- --coverage` (pass).
- 2026-01-31: Fixed leave poll flow to delete votes before removing participant; added call-order assertions. Tests: `npm --prefix web run test -- pollInvites.test.js` (pass).
- 2026-01-31: Added account dropdown feedback form + feedback data layer, Firestore/Storage rules, and tests. Tests: `npm --prefix web run test -- feedback` (pass), `npm --prefix web run test:rules` (pass).
- 2026-01-31: Switched feedback flow to modal launched from account dropdown. Tests: `npm --prefix web run test -- feedback` (pass).
- 2026-01-31: Deployed feedback modal + rules to staging. Deploy: `firebase deploy --project staging --only hosting,firestore:rules,storage` (success).
- 2026-01-31: Re-deployed staging hosting with `VITE_BUILD_MODE=staging` to fix Google OAuth origin mismatch. Deploy: `VITE_BUILD_MODE=staging firebase deploy --project staging --only hosting` (success).
- 2026-01-31: Added `scripts/deploy-staging.sh` and `scripts/deploy-prod.sh` to enforce build mode; updated runbook. Tests not run (script/docs change).
- 2026-01-31: Updated poll invite flow so pending invites are participants, declines remove votes/participants, and UI now distinguishes pending invites; excluded pending invites from active dashboard lists. Tests: `npm --prefix web run test -- pollInvites.test.js` (pass), `npm --prefix web run test:rules` (pass; emulator warnings), `npm --prefix functions run test -- legacy.callables.test.js` (pass; legacy stderr logged).
- 2026-01-31: Fixed dashboard pending invite filtering fallback, forced invite modal open when pending, and normalized auth email in Firestore rules. Tests: `npm --prefix web run test:rules` (pass; emulator warnings).
- 2026-01-31: Added dashboard quick accept/decline buttons for pending invites and covered with tests. Tests: `npm --prefix web run test -- DashboardPage.test.jsx` (pass; JSX transform warning).
- 2026-01-31: Adjusted poll invite creation/edit/clone to treat all invitees as pending, updated clone callable pendingInvites, and kept dashboard quick actions. Tests: `npm --prefix functions run test -- legacy.clone.test.js` (pass), `npm --prefix web run test -- DashboardPage.test.jsx` (pass; JSX transform warning).
- 2026-01-31: Reworked poll invite saving/creation to send all invites as pending, adjusted cloneSchedulerPoll pendingInvites, and redeployed staging (hosting + functions). Tests: `npm --prefix functions run test -- legacy.clone.test.js` (pass), `npm --prefix web run test -- DashboardPage.test.jsx` (pass; JSX transform warning).
- 2026-01-31: Fixed sendPollInvites to keep pending invites even when invitees are already participants (non-group), expanded e2e seed data for poll invite scenarios, and added poll-invite flow e2e coverage (chromium-only, stateful). Tests: `npm --prefix functions run test -- legacy.callables.test.js` (pass), `npm --prefix web run test:e2e:emulators` (pass; poll-invite-flow skipped on firefox/mobile).
- 2026-01-31: Deployed updated functions (sendPollInvites pending-invite fix) to staging. Deploy: `firebase deploy --only functions --project quest-scheduler-stg` (success).
- 2026-01-31: Added edge-case coverage updates (poll invite e2e pending-session assertions, decline-by-email unit test, invitee-accept rules test). Tests pending.
- 2026-01-31: Edge-case pass tests. Tests: `npm --prefix web run test -- pollInvites.test.js` (pass), `npm --prefix web run test:rules` (pass; emulator permission warnings), `npm --prefix web run test:e2e:emulators` (pass; poll-invite-flow skipped on firefox/mobile).
- 2026-01-31: Added auto-dismiss of poll invite notifications on accept/decline, e2e check for auto-clear on decline, and function coverage for email-only invites. Tests pending.
- 2026-01-31: Auto-clear notifications on poll invite accept/decline implemented + coverage. Tests: `npm --prefix functions run test -- legacy.callables.test.js` (pass), `npm --prefix web run test -- pollInvites.test.js` (pass), `npm --prefix web run test:rules` (pass; emulator permission warnings), `npm --prefix web run test:e2e:emulators` (pass; poll-invite-flow skipped on firefox/mobile).
- 2026-01-31: Added friend/group invite auto-dismiss handling (accept/decline), suppressed blocked group invites, added friend request revoke callable + outgoing cancel UI, and expanded auto-clear coverage. Tests: `npm --prefix web run test -- friends.test.js questingGroups.test.js` (pass), `npm --prefix functions run test -- legacy.callables.test.js notifications/auto-clear.test.js` (pass; legacy stderr logged).
- 2026-01-31: Hardened invite notification clearing (delete fallback + waitForPendingWrites), verified pending invite persistence, and stabilized friend/group invite e2e selectors/timing (modal targeting + invite button scoping). Tests: `npm --prefix web run test -- pollInvites.test.js` (pass), `npm --prefix web run test -- friends.test.js` (pass), `npm --prefix web run test -- questingGroups.test.js` (pass), `npm --prefix web run test:e2e:emulators` (pass).
- 2026-01-31: Sanity run all test suites (web/functions/unit/rules/e2e/coverage). Tests: `npm --prefix web run test` (pass), `npm --prefix functions run test` (pass), `npm --prefix web run test:rules` (pass; emulator permission warnings), `npm --prefix web run test:e2e:emulators` (pass; 20 skipped), `npm --prefix web run test:coverage` (pass), `npm --prefix functions run test -- --coverage` (pass).
- 2026-01-31: Deployed staging (hosting + firestore rules/indexes + storage rules) with `VITE_BUILD_MODE=staging`. Deploy: `scripts/deploy-staging.sh` (success; rules ternary type warning).
- 2026-01-31: Deployed production (hosting + functions + firestore rules/indexes + storage rules) with `VITE_BUILD_MODE=production`. Deploy: `DEPLOY_ONLY=hosting,functions,firestore,storage scripts/deploy-prod.sh` (success; rules ternary type warning).
- 2026-02-01: Added composite Firestore indexes for schedulers pending invite queries (creatorEmail/creatorId + pendingInvites). Tests not run (index-only change).
